{% extends 'base.html' %}

{% block title %}Cuentas{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Cuentas</h3>
        <div class="card-actions">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newAccountModal">Nueva Cuenta</button>
        </div>
    </div>
    <div class="card-body">
        <table class="table table-vcenter">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Tipo</th>
                    <th>Moneda</th>
                    <th>Balance</th>
                    <th>Deuda</th>
                    <th>Disponible</th>
                </tr>
            </thead>
            <tbody>
                {% for account in accounts %}
                <tr>
                    <td>{{ account.name }}</td>
                    <td>{{ account.get_type_display }}</td>
                    <td>{{ account.currency }}</td>
                    <td>{{ account.balance|floatformat:2 }}</td>
                    <td>{% if account.type == 'CREDITO' %}{{ account.credit_used|floatformat:2 }}{% else %}-{% endif %}</td>
                    <td>{% if account.type == 'CREDITO' %}{{ account.available_credit|floatformat:2 }}{% else %}-{% endif %}</td>
                    <td><a href="?edit={{ account.id }}" class="btn btn-sm btn-outline-primary">Editar</a></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal for new/edit account -->
<div class="modal modal-blur fade" id="newAccountModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{% if edit_account %}Editar Cuenta{% else %}Nueva Cuenta{% endif %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post">
                {% csrf_token %}
                {% if edit_account %}<input type="hidden" name="account_id" value="{{ edit_account.id }}">{% endif %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Nombre</label>
                        <input type="text" class="form-control" name="name" value="{% if edit_account %}{{ edit_account.name }}{% endif %}" required autocomplete="off">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tipo</label>
                        <select class="form-select" name="type" id="account-type-select" required>
                            <option value="EFECTIVO" {% if edit_account and edit_account.type == 'EFECTIVO' %}selected{% endif %}>Efectivo</option>
                            <option value="DEBITO" {% if edit_account and edit_account.type == 'DEBITO' %}selected{% endif %}>Débito</option>
                            <option value="CREDITO" {% if edit_account and edit_account.type == 'CREDITO' %}selected{% endif %}>Crédito</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Moneda</label>
                        <select class="form-select" name="currency">
                            <option value="PEN" {% if edit_account and edit_account.currency == 'PEN' %}selected{% endif %}>PEN</option>
                            <option value="USD" {% if edit_account and edit_account.currency == 'USD' %}selected{% endif %}>USD</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Balance Inicial</label>
                        <input type="number" step="0.01" class="form-control" name="opening_balance" value="{% if edit_account %}{{ edit_account.opening_balance }}{% else %}0.00{% endif %}">
                    </div>
                    <div class="mb-3" id="credit-limit-field" style="{% if edit_account and edit_account.type == 'CREDITO' %}display: block;{% else %}display: none;{% endif %}">
                        <label class="form-label">Límite de Crédito</label>
                        <input type="number" step="0.01" class="form-control" name="credit_limit" value="{% if edit_account %}{{ edit_account.credit_limit }}{% endif %}">
                    </div>
                    <div class="mb-3" id="billing-cycle-field" style="{% if edit_account and edit_account.type == 'CREDITO' %}display: block;{% else %}display: none;{% endif %}">
                        <label class="form-label">Día de Ciclo de Facturación</label>
                        <input type="number" min="1" max="31" class="form-control" name="billing_cycle_day" value="{% if edit_account %}{{ edit_account.billing_cycle_day }}{% endif %}">
                    </div>
                    <div class="mb-3" id="due-day-field" style="{% if edit_account and edit_account.type == 'CREDITO' %}display: block;{% else %}display: none;{% endif %}">
                        <label class="form-label">Día de Vencimiento</label>
                        <input type="number" min="1" max="31" class="form-control" name="due_day" value="{% if edit_account %}{{ edit_account.due_day }}{% endif %}">
                    </div>
                    <div class="mb-3" id="savings-amount-field" style="{% if edit_account and edit_account.type == 'DEBITO' %}display: block;{% else %}display: none;{% endif %}">
                        <label class="form-label">Monto de Ahorro</label>
                        <input type="number" step="0.01" class="form-control" name="savings_amount" value="{% if edit_account %}{{ edit_account.savings_amount }}{% endif %}">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Show modal if editing
    {% if edit_account %}
    var modal = new bootstrap.Modal(document.getElementById('newAccountModal'));
    modal.show();
    {% endif %}

    // Existing type change logic
    document.getElementById('account-type-select').addEventListener('change', function() {
        const type = this.value;
        const creditLimitField = document.getElementById('credit-limit-field');
        const billingCycleField = document.getElementById('billing-cycle-field');
        const dueDayField = document.getElementById('due-day-field');
        const savingsAmountField = document.getElementById('savings-amount-field');

        creditLimitField.style.display = type === 'CREDITO' ? 'block' : 'none';
        billingCycleField.style.display = type === 'CREDITO' ? 'block' : 'none';
        dueDayField.style.display = type === 'CREDITO' ? 'block' : 'none';
        savingsAmountField.style.display = type === 'DEBITO' ? 'block' : 'none';
    });
});
</script>

<script>
document.getElementById('account-type-select').addEventListener('change', function() {
    const type = this.value;
    const creditLimitField = document.getElementById('credit-limit-field');
    const billingCycleField = document.getElementById('billing-cycle-field');
    const dueDayField = document.getElementById('due-day-field');
    const savingsAmountField = document.getElementById('savings-amount-field');

    creditLimitField.style.display = type === 'CREDITO' ? 'block' : 'none';
    billingCycleField.style.display = type === 'CREDITO' ? 'block' : 'none';
    dueDayField.style.display = type === 'CREDITO' ? 'block' : 'none';
    savingsAmountField.style.display = type === 'DEBITO' ? 'block' : 'none';
});
</script>
{% endblock %}